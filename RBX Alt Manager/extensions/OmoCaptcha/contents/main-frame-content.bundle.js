(()=>{const e="undefined"!=typeof browser?browser.runtime:chrome.runtime;function t(){const t=Array.from(document.querySelectorAll("iframe")).map(((e,t)=>{const n=e.getBoundingClientRect();return{index:t,rect:{left:n.left,top:n.top,width:n.width,height:n.height},src:e.src||null,scrollX:window.scrollX,scrollY:window.scrollY}}));e.sendMessage({type:"frameReport",data:{url:location.href,iframes:t}}).then((e=>{})).catch((e=>{}));window.self,window.top;t.length}t("document_end");let n=document.querySelectorAll("iframe").length,o=null;new MutationObserver((e=>{const r=document.querySelectorAll("iframe").length;r!==n&&(n=r,o&&clearTimeout(o),o=setTimeout((()=>{t("mutation_"+r+"_iframes")}),100))})).observe(document.documentElement||document.body,{childList:!0,subtree:!0});let r=0;const s=setInterval((()=>{r++;const e=document.querySelectorAll("iframe").length;e!==n&&(n=e,t("rescan_"+r+"_found_"+e)),r>=10&&clearInterval(s)}),500);e.onMessage.addListener(((e,t,n)=>{if("getIframeRectByUrl"===e.type){const t=e.url,o=document.querySelectorAll("iframe");for(const e of o)if(e.src)try{if(e.src===t){const t=e.getBoundingClientRect();return n({found:!0,rect:{left:t.left,top:t.top,width:t.width,height:t.height}}),!0}const o=new URL(e.src).hostname;if(o===new URL(t).hostname){const r=new URL(e.src).pathname,s=new URL(t).pathname;if(o.includes("hcaptcha.com")&&r===s){const o=new URL(e.src).hash||"",r=new URL(t).hash||"",s=o.includes("frame=challenge")?"challenge":o.includes("frame=checkbox")?"checkbox":"unknown";if(s===(r.includes("frame=challenge")?"challenge":r.includes("frame=checkbox")?"checkbox":"unknown")&&"unknown"!==s){const t=e.getBoundingClientRect();return n({found:!0,rect:{left:t.left,top:t.top,width:t.width,height:t.height}}),!0}continue}if(r===s){const t=e.getBoundingClientRect();return n({found:!0,rect:{left:t.left,top:t.top,width:t.width,height:t.height}}),!0}}}catch(e){}return n({found:!1}),!0}})),window.self===window.top&&e.onMessage.addListener(((e,t,n)=>{switch(e.type){case"getAllRectIframe":const t=function(){const e=document.querySelectorAll("iframe");return Array.from(e).map((e=>{const t=e.getBoundingClientRect();return{src:e.src||null,rect:{top:t.top,left:t.left,width:t.width,height:t.height}}}))}();n(t);break;case"cropImage":const{screenshotDataUrl:o,cropConfig:r}=e,s=new Image;return s.onload=()=>{try{const e=document.createElement("canvas"),t=window.devicePixelRatio||1;e.width=r.width*t,e.height=r.height*t;e.getContext("2d").drawImage(s,r.left*t,r.top*t,r.width*t,r.height*t,0,0,r.width*t,r.height*t);const o=e.toDataURL("image/png").replace("data:image/png;base64,","");n({base64:o})}catch(e){n({error:e.message})}},s.onerror=()=>n({error:"Không thể load ảnh để crop."}),s.src=o,!0}})),window.addEventListener("message",(e=>{switch(e.data.type){case"getParentData":const t=document.querySelector("[data-sitekey]"),n=t?t.getAttribute("data-sitekey"):null,o=window.location.href;e.source.postMessage({type:"parentDataResponse",siteKey:n,websiteURL:o},e.origin);break;case"setToken":try{const t=document.querySelector('textarea[name="g-recaptcha-response"]');t?(t.value=e.data.token,e.source.postMessage({type:"setTokenResponse",success:!0},e.origin)):e.source.postMessage({type:"setTokenResponse",success:!1,error:"No textarea with name g-recaptcha-response found"},e.origin)}catch(t){e.source.postMessage({type:"setTokenResponse",success:!1,error:t.message},e.origin)}break;case"displayMessage":const{text:r,background:s}=e.data.message,c=document.querySelector("[data-sitekey]");let a=document.getElementById("messageOfToken");!a&&c&&(a=document.createElement("div"),a.id="messageOfToken",a.style.position="relative",a.style.margin="5px auto",a.style.padding="3px 3px",a.style.borderRadius="3px",a.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",a.style.fontSize="12px",a.style.fontWeight="600",a.style.fontFamily="Arial, sans-serif",a.style.textAlign="center",a.style.whiteSpace="nowrap",a.style.color="white",a.style.maxWidth="303px",c.parentNode.insertBefore(a,c.nextSibling)),a&&(a.innerText=r,a.style.background=s,a.style.display="block");break;case"checkboxStateHcaptcha":const i=document.querySelector('iframe[src*="frame=challenge"]');i?.contentWindow&&i.contentWindow.postMessage({type:"checkboxStateHcaptcha",state:e.data.state},"*");break;case"reloadMainPage":window.location.reload()}}))})();