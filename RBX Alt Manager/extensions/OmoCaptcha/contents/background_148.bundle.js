(()=>{"use strict";let e=Promise.resolve();const t=async(t,r)=>{const a="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,o="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{return e=e.then((()=>new Promise(((e,n)=>{a.set({[t]:r},(()=>{o.lastError?n(new Error(`Error setting ${t}: ${o.lastError.message}`)):e(!0)}))})))),await e,!0}catch(e){throw e}},r={API_KEY:{key:"api_key",defaultValue:""},APP_ID:{key:"appId",defaultValue:""},POWER_ON:{key:"power_on",defaultValue:!0},TIKTOK:{key:"tiktok",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},FUNCAPTCHA:{key:"funcaptcha",defaultValue:{delayClick:100,loop:!0,isActive:!0,maxImageCaptcha:25}},ZALO:{key:"zalo",defaultValue:{delayClick:100,loop:!0,isActive:!0}},SHOPEE:{key:"shopee",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},RECAPTCHAV2:{key:"reCaptchav2",defaultValue:{delayClick:500,loop:!0,isActive:!0,useToken:!1}},AMZN:{key:"amzn",defaultValue:{delayClick:100,loop:!0,isActive:!0}},GEETEST:{key:"geetest",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},SLIDE_ALL:{key:"slide_all",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},HCAPTCHA:{key:"hcaptcha",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},CLOUDFLARE:{key:"cloudflare",defaultValue:{delayClick:2e3,isActive:!0}},TENCENT:{key:"tencent",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}}};let a="omocaptcha.com";const o={register_language:async()=>{const e="undefined"!=typeof browser?browser.declarativeNetRequest:chrome.declarativeNetRequest,t="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{await new Promise(((r,a)=>{e.updateDynamicRules({removeRuleIds:[1,2,3],addRules:[{id:1,priority:1,action:{type:"redirect",redirect:{transform:{queryTransform:{addOrReplaceParams:[{key:"lang",value:"vi"}]}}}},condition:{regexFilter:"^https://zcaptcha\\.api\\.zaloapp\\.com/",resourceTypes:["main_frame","sub_frame","xmlhttprequest"]}},{id:2,priority:1,action:{type:"redirect",redirect:{transform:{queryTransform:{addOrReplaceParams:[{key:"hl",value:"en-US"}]}}}},condition:{regexFilter:"^(http|https)://[^\\.]*\\.(google\\.com|recaptcha\\.net)/recaptcha",resourceTypes:["sub_frame"]}},{id:3,priority:1,action:{type:"modifyHeaders",requestHeaders:[{header:"Accept-Language",operation:"set",value:"en-US,en;q=0.9"}]},condition:{urlFilter:"*",resourceTypes:["main_frame","sub_frame","xmlhttprequest","script","stylesheet","image","object","ping","csp_report","media","font","websocket","webtransport","webbundle","other"]}}]},(()=>{t.lastError?a(new Error(`Error updating dynamic rules: ${t.lastError.message}`)):r()}))}))}catch(e){throw e}},register_set_key_from_url:()=>{("undefined"!=typeof browser?browser.webNavigation:chrome.webNavigation).onCommitted.addListener((async e=>{try{if(!e.url)return;const o=new URL(e.url);if(o.hostname!==a&&!o.hostname.endsWith("."+a))return;const n=o.searchParams.get("api_key"),s=o.searchParams.get("app_id");if(!n&&!s)return;n&&await t(r.API_KEY.key,n),s&&await t(r.APP_ID.key,s)}catch(e){}}))}},n=o;async function s(e){return new Promise((t=>setTimeout(t,e)))}const i={GET_BALANCE_URL:"https://api.omocaptcha.com/v2/getBalance",CREATE_JOB_URL:"https://api.omocaptcha.com/v2/createTask",GET_RESULT_URL:"https://api.omocaptcha.com/v2/getTaskResult",REPORT_URL:"https://api.omocaptcha.com/v2/report"};n.register_language(),n.register_set_key_from_url();const c=async()=>{const e="undefined"!=typeof browser?browser.runtime:chrome.runtime,a="undefined"!=typeof browser?browser.storage.local:chrome.storage.local;try{if(!(await a.get("initialized")).initialized){const a=await fetch(e.getURL("configs.json"));if(!a.ok)throw new Error(`Failed to fetch configs.json: ${a.status}`);const o=await a.json(),n={[r.API_KEY.key]:r.API_KEY.defaultValue,[r.APP_ID.key]:r.APP_ID.defaultValue,[r.POWER_ON.key]:r.POWER_ON.defaultValue,[r.TIKTOK.key]:r.TIKTOK.defaultValue,[r.FUNCAPTCHA.key]:r.FUNCAPTCHA.defaultValue,[r.ZALO.key]:r.ZALO.defaultValue,[r.SHOPEE.key]:r.SHOPEE.defaultValue,[r.RECAPTCHAV2.key]:r.RECAPTCHAV2.defaultValue,[r.AMZN.key]:r.AMZN.defaultValue,[r.GEETEST.key]:r.GEETEST.defaultValue,[r.SLIDE_ALL.key]:r.SLIDE_ALL.defaultValue,[r.HCAPTCHA.key]:r.HCAPTCHA.defaultValue,[r.CLOUDFLARE.key]:r.CLOUDFLARE.defaultValue,[r.TENCENT.key]:r.TENCENT.defaultValue},i=async function(e,r){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3;for(let o=1;o<=a;o++)try{return void await t(e,r)}catch(t){if(o===a)throw new Error(`Failed to set ${e}: ${t.message}`);await s(500)}};await Promise.all([...Object.entries(n).map((e=>{let[t,r]=e;return i(t,r)})),...Object.entries(o).map((e=>{let[t,r]=e;return i(t,r)})),i("initialized",!0)])}}catch(e){throw e}},l="undefined"!=typeof browser?browser.runtime:chrome.runtime,d="undefined"!=typeof browser?browser.tabs:chrome.tabs;let u,f,p;l.onStartup.addListener((async()=>{await c()})),l.onInstalled.addListener((async()=>{await c()})),u=i.CREATE_JOB_URL,f=i.GET_RESULT_URL,p=i.REPORT_URL,l.onMessage.addListener(((e,t,a)=>{switch(e.type){case"getURL":return async function(e,t){const r="undefined"!=typeof browser?browser.tabs:chrome.tabs;if(e.tab&&e.tab.id)try{t((await r.get(e.tab.id)).url)}catch(e){t("")}else t("")}(t,a),!0;case"createTask":return async function(e,t){let a=await(async(e,t)=>{const r="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,a="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{const o=await r.get([e]);if(a.lastError)throw new Error(`Error retrieving ${e}: ${a.lastError.message}`);return null!=o[e]?o[e]:t}catch(e){throw e}})(r.APP_ID.key,r.APP_ID.defaultValue);const o=JSON.parse(e);o.appId=a;try{const e=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),r=await e.json();if(!e.ok)return void t({message:r.message});0===Number(r.errorId)?t({taskId:r.taskId}):t({error:!0,errorCode:r.errorCode,errorDescription:r.errorDescription})}catch(e){t("")}}(e.data,a),!0;case"getTaskResult":return async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,r=arguments.length>2?arguments[2]:void 0;try{const a=Date.now();for(;Date.now()-a<=1e3*t;){await s(350);try{const t=await fetch(f,{method:"POST",headers:{"Content-Type":"application/json"},body:e});if(!t.ok)continue;const a=await t.json();if(a.status&&("ready"===a.status||"fail"===a.status))return void r(a)}catch(e){await s(1e3)}}r("")}catch(e){r("")}}(e.data.data,e.data.timeWait,a),!0;case"reportTask":return async function(e,t){try{const r={id:e.taskIds||[],isSuccess:e.result,crxVersion:l.getManifest().version},a=await fetch(p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok)throw new Error(`HTTP error! Status: ${a.status}`);t(await a.json())}catch(e){t("")}}(e.data,a),!0;case"createImageBase64":return async function(e,t){try{const r=await fetch(e),a=await r.blob(),o=new FileReader;o.onloadend=()=>{const e=o.result.split(",")[1];t(e)},o.onerror=()=>{t("")},o.readAsDataURL(a)}catch(e){t("")}}(e.data.url,a),!0;case"getCanvasBase64_screenshot":return async function(e,t,r){if(!e||!e.id)return void r({error:"Tab không hợp lệ."});const a=e.id;try{const o=e.frameId||0;let n=await async function(e,t,r){if(0===t)return{left:r.left,top:r.top};let a=t,o=r.left,n=r.top;const s=new Set;for(;0!==a;){if(s.has(a))return null;s.add(a);const t=m[e]?.[a];if(!t)return null;let r=t.parentFrameId;if(-1===r){const t=w(e,a);r=t?t.parentFrameId:0}let i=null;try{const o=await g(e,{type:"getIframeRectByUrl",url:t.url},r);if(o&&o.found)i=o.rect;else{const t=w(e,a);t&&t.iframeRect&&(i=t.iframeRect)}}catch(t){const r=w(e,a);r&&r.iframeRect&&(i=r.iframeRect)}if(!i)return null;o+=i.left,n+=i.top,a=r}return{left:o,top:n}}(a,o,{left:t.left,top:t.top});if(!n){const e=(await g(a,{type:"getAllRectIframe"})).find((e=>e.src?.includes("frame=challenge")));if(!e)return void r({error:"Không tìm thấy frame hCaptcha."});n={left:e.rect.left+t.left,top:e.rect.top+t.top}}const s=await d.captureVisibleTab(e.windowId,{format:"png"}),i={left:n.left,top:n.top,width:t.width,height:t.height},c=await g(a,{type:"cropImage",screenshotDataUrl:s,cropConfig:i},0);if(c.error)return void r({error:c.error});r({base64:c.base64})}catch(e){r({error:`Đã xảy ra lỗi: ${e.message}`})}}({...t.tab,frameId:t.frameId},e.data.rectCanvas,a),!0;case"frameReport":const o=t.tab?.id,n=t.frameId;let i=t.parentFrameId;return null==i&&(i=-1),o?(m[o]||(m[o]={}),m[o][n]={frameId:n,parentFrameId:i,url:t.url,iframes:e.data.iframes},a({received:!0}),!0):(a({error:"No tab ID"}),!0);case"logCaptchaToLocal":return async function(e,t){try{const r=await fetch("http://localhost:3000/log-captcha",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});t(await r.json())}catch(e){t({error:e.message})}}(e.data,a),!0;default:return a(""),!0}}));const m={},y="undefined"!=typeof browser?browser.webNavigation:chrome.webNavigation,h="undefined"!=typeof browser?browser.tabs:chrome.tabs;function w(e,t){const r=m[e];if(!r)return null;const a=r[t];if(!a)return null;const o=a.url;if(!o)return null;for(const[e,a]of Object.entries(r)){const r=parseInt(e,10);if(r!==t)for(const e of a.iframes||[])if(e.src){if(e.src===o)return{parentFrameId:r,iframeRect:e.rect};try{const t=new URL(e.src).hostname;if(t===new URL(o).hostname){const a=new URL(e.src).pathname,n=new URL(o).pathname;if(t.includes("hcaptcha.com")&&a===n){const t=new URL(e.src).hash||"",a=new URL(o).hash||"",n=t.includes("frame=challenge")?"challenge":t.includes("frame=checkbox")?"checkbox":"unknown";if(n===(a.includes("frame=challenge")?"challenge":a.includes("frame=checkbox")?"checkbox":"unknown")&&"unknown"!==n)return{parentFrameId:r,iframeRect:e.rect};continue}if(a===n)return{parentFrameId:r,iframeRect:e.rect}}}catch(e){}}}return null}function g(e,t,r){const a=void 0!==r?{frameId:r}:{};return"undefined"!=typeof browser?browser.tabs.sendMessage(e,t,a):new Promise(((r,o)=>{chrome.tabs.sendMessage(e,t,a,(e=>{const t=chrome.runtime.lastError;if(t)return o(t);r(e)}))}))}y&&y.onCommitted.addListener((e=>{0===e.frameId&&e.tabId&&delete m[e.tabId]})),h&&h.onRemoved.addListener((e=>{delete m[e]}))})();